<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ë‹¨ì–´ ì•”ê¸° ì›¹ì‚¬ì´íŠ¸</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Noto Sans KR", sans-serif;
      }
      .modal-open {
        overflow: hidden;
      }
    </style>
  </head>
  <body class="bg-gray-50 text-gray-800">
    <!-- ìƒë‹¨ ë„¤ë¹„ê²Œì´ì…˜ ë°” -->
    <header class="bg-white shadow-sm sticky top-0 z-40">
      <nav
        class="container mx-auto px-6 py-3 flex justify-between items-center"
      >
        <a href="#" id="logo" class="text-2xl font-bold text-blue-600"
          >ë‹¨ì–´ì¥</a
        >
      </nav>
    </header>

    <main class="container mx-auto p-6">
      <!-- ë©”ì¸ í™”ë©´ ì»¨í…Œì´ë„ˆ -->
      <div id="main-view">
        <section id="home" class="mb-16">
          <div class="bg-white p-8 rounded-xl shadow-md mb-8">
            <h1 class="text-3xl font-bold mb-2">ì˜ˆì€ë‹˜, ì˜¤ëŠ˜ë„ í™”ì´íŒ…!</h1>
            <p class="text-gray-600 mb-4">
              ì˜¤ëŠ˜ì˜ í•™ìŠµ ëª©í‘œë¥¼ í–¥í•´ ë‹¬ë ¤ë³´ì„¸ìš”.
            </p>
            <div>
              <div class="flex justify-between items-center mb-1">
                <span class="text-base font-medium text-blue-700"
                  >ì˜¤ëŠ˜ì˜ í•™ìŠµëŸ‰</span
                >
                <div class="flex items-center">
                  <span id="goal-text" class="text-sm font-medium text-blue-700"
                    >0 / 30 ë‹¨ì–´</span
                  >
                  <button
                    id="edit-goal-btn"
                    class="ml-2 text-gray-500 hover:text-blue-600"
                  >
                    <i class="fa-solid fa-pen-to-square"></i>
                  </button>
                </div>
              </div>
              <div class="w-full bg-gray-200 rounded-full h-2.5">
                <div
                  id="progress-bar"
                  class="bg-blue-600 h-2.5 rounded-full"
                  style="width: 0%"
                ></div>
              </div>
            </div>
          </div>

          <h2 class="text-2xl font-bold mb-6">ë‚˜ì˜ ë‹¨ì–´ì¥ ë§Œë“¤ê¸°</h2>
          <div class="bg-white p-8 rounded-xl shadow-md">
            <div class="space-y-4">
              <div>
                <label
                  for="wordbook-name-input"
                  class="block text-sm font-medium text-gray-700"
                  >ìƒˆ ë‹¨ì–´ì¥ ì´ë¦„</label
                >
                <input
                  type="text"
                  id="wordbook-name-input"
                  placeholder="ì˜ˆ: í† ìµ ë¹ˆì¶œ ë‹¨ì–´"
                  class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                />
              </div>
              <div class="pt-2">
                <button
                  id="create-wordbook-btn"
                  class="w-full flex items-center justify-center bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 transition"
                >
                  <i class="fa-solid fa-plus mr-2"></i>
                  ë§Œë“¤ê³  ë‹¨ì–´ ì¶”ê°€í•˜ê¸°
                </button>
              </div>
            </div>
          </div>
        </section>

        <section id="wordbooks" class="mb-16">
          <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold">ë‚˜ì˜ ë‹¨ì–´ì¥ ëª©ë¡</h2>
          </div>
          <div
            id="wordbooks-list"
            class="grid md:grid-cols-2 lg:grid-cols-3 gap-6"
          >
            <!-- JavaScriptë¡œ ë‹¨ì–´ì¥ ëª©ë¡ì´ ì—¬ê¸°ì— ìƒì„±ë©ë‹ˆë‹¤. -->
          </div>
        </section>
      </div>

      <!-- í•™ìŠµ í™”ë©´ ì»¨í…Œì´ë„ˆ -->
      <div id="learn-view" class="hidden">
        <section id="learn" class="mb-16">
          <div class="flex justify-between items-center mb-6">
            <h2 id="learn-wordbook-title" class="text-2xl font-bold"></h2>
            <button
              id="exit-learn-btn"
              class="px-4 py-2 bg-gray-200 rounded-md hover:bg-gray-300"
            >
              ë‚˜ê°€ê¸°
            </button>
          </div>
          <div class="max-w-xl mx-auto">
            <div
              id="learn-progress"
              class="text-center text-lg font-semibold mb-4"
            ></div>
            <!-- Static Card -->
            <div class="bg-white rounded-xl shadow-lg p-8 text-center">
              <p class="text-gray-500 text-sm">ë‹¨ì–´</p>
              <h3 id="learn-word-display" class="text-5xl font-bold my-4"></h3>
              <hr class="my-6" />
              <p class="text-gray-500 text-sm">ëœ»</p>
              <h4
                id="learn-meaning-display"
                class="text-3xl font-bold text-blue-600 mt-2"
              ></h4>
            </div>
            <div class="mt-6">
              <button
                id="learn-next-btn"
                class="w-full bg-gray-700 text-white font-bold py-3 rounded-lg hover:bg-gray-800 transition"
              >
                ë‹¤ìŒ
              </button>
            </div>
          </div>
        </section>
      </div>

      <!-- í€´ì¦ˆ í™”ë©´ ì»¨í…Œì´ë„ˆ -->
      <div id="quiz-view" class="hidden">
        <section id="quiz" class="mb-16">
          <div class="flex justify-between items-center mb-6">
            <h2 id="quiz-wordbook-title" class="text-2xl font-bold"></h2>
            <button
              id="exit-quiz-btn"
              class="px-4 py-2 bg-gray-200 rounded-md hover:bg-gray-300"
            >
              ë‚˜ê°€ê¸°
            </button>
          </div>
          <div class="max-w-xl mx-auto">
            <div
              id="quiz-progress"
              class="text-center text-lg font-semibold mb-4"
            ></div>
            <div class="bg-white p-8 rounded-xl shadow-md">
              <p class="text-gray-600 mb-2">ë‹¨ì–´</p>
              <h3 id="quiz-word" class="text-4xl font-bold mb-6"></h3>
              <label
                for="quiz-meaning-input"
                class="block text-sm font-medium text-gray-700 mb-1"
                >ëœ»ì„ ì…ë ¥í•˜ì„¸ìš”:</label
              >
              <input
                type="text"
                id="quiz-meaning-input"
                class="w-full px-3 py-2 border border-gray-300 rounded-md"
              />
            </div>
            <button
              id="next-quiz-btn"
              class="mt-6 w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 transition"
            >
              ë‹¤ìŒ ë¬¸ì œ
            </button>
          </div>
        </section>
      </div>

      <!-- í€´ì¦ˆ ê²°ê³¼ í™”ë©´ ì»¨í…Œì´ë„ˆ -->
      <div id="quiz-result-view" class="hidden">
        <section id="quiz-result" class="mb-16 text-center">
          <div class="max-w-xl mx-auto bg-white p-8 rounded-xl shadow-md">
            <h2 class="text-3xl font-bold mb-4">í€´ì¦ˆ ê²°ê³¼</h2>
            <div class="text-6xl font-bold text-blue-600 mb-2">
              <span id="quiz-score"></span> / <span id="quiz-total"></span>
            </div>
            <p id="quiz-feedback" class="text-lg text-gray-700 mb-8"></p>
            <button
              id="back-to-main-btn"
              class="w-full bg-gray-700 text-white font-bold py-3 rounded-lg hover:bg-gray-800 transition"
            >
              ë©”ì¸ìœ¼ë¡œ ëŒì•„ê°€ê¸°
            </button>
          </div>
        </section>
      </div>
    </main>

    <!-- ëª¨ë“  ëª¨ë‹¬ë“¤ -->
    <div
      id="goal-modal"
      class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center"
    >
      <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-sm">
        <h3 class="text-xl font-bold mb-4">í•™ìŠµ ëª©í‘œ ì„¤ì •</h3>
        <label
          for="daily-goal-input"
          class="block text-sm font-medium text-gray-700"
          >í•˜ë£¨ì— ì•”ê¸°í•  ë‹¨ì–´ ìˆ˜</label
        >
        <input
          type="number"
          id="daily-goal-input"
          value="30"
          class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md"
        />
        <div class="mt-6 flex justify-end space-x-4">
          <button
            class="close-modal-btn px-4 py-2 bg-gray-200 rounded-md hover:bg-gray-300"
          >
            ì·¨ì†Œ
          </button>
          <button
            id="save-goal-btn"
            class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700"
          >
            ì €ì¥
          </button>
        </div>
      </div>
    </div>
    <div
      id="add-word-modal"
      class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center p-4"
    >
      <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md relative">
        <button
          class="close-modal-btn absolute top-4 right-4 text-gray-500 hover:text-gray-800"
        >
          <i class="fa-solid fa-xmark fa-lg"></i>
        </button>
        <h3 class="text-xl font-bold mb-2">ë‹¨ì–´ ì¶”ê°€í•˜ê¸°</h3>
        <p class="text-gray-600 mb-6">
          ë‹¨ì–´ì¥: <span id="modal-wordbook-name" class="font-semibold"></span>
        </p>
        <div class="space-y-4">
          <button
            id="add-manually-btn"
            class="w-full flex items-center justify-center bg-gray-700 text-white font-bold py-3 px-6 rounded-lg hover:bg-gray-800 transition"
          >
            <i class="fa-solid fa-pencil mr-2"></i> ì§ì ‘ ì…ë ¥í•˜ê¸°
          </button>
          <button
            id="add-from-photo-btn"
            class="w-full flex items-center justify-center bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 transition"
          >
            <i class="fa-solid fa-camera mr-2"></i> ì‚¬ì§„ìœ¼ë¡œ ì—¬ëŸ¬ ë‹¨ì–´ ì¶”ê°€
          </button>
        </div>
      </div>
    </div>
    <div
      id="photo-add-modal"
      class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center p-4"
    >
      <div
        class="bg-white p-8 rounded-lg shadow-xl w-full max-w-2xl relative max-h-[90vh] flex flex-col"
      >
        <button
          class="close-modal-btn absolute top-4 right-4 text-gray-500 hover:text-gray-800"
        >
          <i class="fa-solid fa-xmark fa-lg"></i>
        </button>
        <h3 class="text-xl font-bold mb-4">ì‚¬ì§„ì—ì„œ ë‹¨ì–´ ì¸ì‹</h3>
        <div class="flex-grow overflow-y-auto pr-2">
          <div
            id="photo-upload-area"
            class="w-full h-48 bg-gray-100 border-2 border-dashed rounded-lg flex flex-col justify-center items-center mb-4 cursor-pointer"
          >
            <i class="fa-solid fa-image text-gray-400 text-4xl mb-2"></i>
            <p class="text-gray-500">ë‹¨ì–´ê°€ í¬í•¨ëœ ì‚¬ì§„ì„ ì—…ë¡œë“œí•˜ì„¸ìš”</p>
            <input
              type="file"
              id="photo-upload-input"
              class="hidden"
              accept="image/*"
            />
          </div>
          <h4 class="font-semibold mb-2">ì¸ì‹ëœ ë‹¨ì–´ ëª©ë¡</h4>
          <p class="text-sm text-gray-500 mb-4">
            ì¶”ê°€í•  ë‹¨ì–´ë¥¼ í™•ì¸í•˜ê³  ìˆ˜ì •í•˜ì„¸ìš”. (ë°ëª¨)
          </p>
          <div id="recognized-words-list" class="space-y-3"></div>
        </div>
        <div class="mt-6 pt-4 border-t">
          <button
            id="save-photo-words-btn"
            class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700"
          >
            ì„ íƒí•œ ë‹¨ì–´ ëª¨ë‘ ì¶”ê°€
          </button>
        </div>
      </div>
    </div>
    <div
      id="manual-add-modal"
      class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center p-4"
    >
      <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md relative">
        <button
          class="close-modal-btn absolute top-4 right-4 text-gray-500 hover:text-gray-800"
        >
          <i class="fa-solid fa-xmark fa-lg"></i>
        </button>
        <h3 class="text-xl font-bold mb-4">ì§ì ‘ ë‹¨ì–´ ì¶”ê°€</h3>
        <div class="space-y-4">
          <div>
            <label
              for="manual-word-input"
              class="block text-sm font-medium text-gray-700"
              >ë‹¨ì–´</label
            >
            <input
              type="text"
              id="manual-word-input"
              class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md"
            />
          </div>
          <div>
            <label
              for="manual-meaning-input"
              class="block text-sm font-medium text-gray-700"
              >ëœ»</label
            >
            <input
              type="text"
              id="manual-meaning-input"
              class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md"
            />
          </div>
        </div>
        <div class="mt-6 pt-4 border-t">
          <button
            id="save-manual-word-btn"
            class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700"
          >
            ë‹¨ì–´ ì¶”ê°€
          </button>
        </div>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        // --- ìƒíƒœ ê´€ë¦¬ (State Management) ---
        let appState = {
          dailyGoal: 30,
          wordsLearnedToday: 0,
          wordbooks: [],
          currentWordbookId: null,
        };

        let learningSession = {
          isActive: false,
          wordbookId: null,
          words: [],
          currentIndex: 0,
        };
        let quizSession = {
          isActive: false,
          wordbookId: null,
          words: [],
          currentIndex: 0,
          score: 0,
          userAnswers: [],
        };

        // --- DOM ìš”ì†Œ ìºì‹± ---
        const DOMElements = {
          body: document.body,
          mainView: document.getElementById("main-view"),
          learnView: document.getElementById("learn-view"),
          quizView: document.getElementById("quiz-view"),
          quizResultView: document.getElementById("quiz-result-view"),
          logo: document.getElementById("logo"),

          goalText: document.getElementById("goal-text"),
          progressBar: document.getElementById("progress-bar"),
          wordbookNameInput: document.getElementById("wordbook-name-input"),
          wordbooksList: document.getElementById("wordbooks-list"),
          createWordbookBtn: document.getElementById("create-wordbook-btn"),

          learnWordbookTitle: document.getElementById("learn-wordbook-title"),
          exitLearnBtn: document.getElementById("exit-learn-btn"),
          learnProgress: document.getElementById("learn-progress"),
          learnWordDisplay: document.getElementById("learn-word-display"),
          learnMeaningDisplay: document.getElementById("learn-meaning-display"),
          learnNextBtn: document.getElementById("learn-next-btn"),

          quizWordbookTitle: document.getElementById("quiz-wordbook-title"),
          exitQuizBtn: document.getElementById("exit-quiz-btn"),
          quizProgress: document.getElementById("quiz-progress"),
          quizWord: document.getElementById("quiz-word"),
          quizMeaningInput: document.getElementById("quiz-meaning-input"),
          nextQuizBtn: document.getElementById("next-quiz-btn"),

          quizScore: document.getElementById("quiz-score"),
          quizTotal: document.getElementById("quiz-total"),
          quizFeedback: document.getElementById("quiz-feedback"),
          backToMainBtn: document.getElementById("back-to-main-btn"),

          editGoalBtn: document.getElementById("edit-goal-btn"),
          goalModal: document.getElementById("goal-modal"),
          addWordModal: document.getElementById("add-word-modal"),
          photoAddModal: document.getElementById("photo-add-modal"),
          manualAddModal: document.getElementById("manual-add-modal"),
          dailyGoalInput: document.getElementById("daily-goal-input"),
          saveGoalBtn: document.getElementById("save-goal-btn"),
          modalWordbookName: document.getElementById("modal-wordbook-name"),
          addManuallyBtn: document.getElementById("add-manually-btn"),
          addFromPhotoBtn: document.getElementById("add-from-photo-btn"),
          photoUploadArea: document.getElementById("photo-upload-area"),
          photoUploadInput: document.getElementById("photo-upload-input"),
          recognizedWordsList: document.getElementById("recognized-words-list"),
          savePhotoWordsBtn: document.getElementById("save-photo-words-btn"),
          manualWordInput: document.getElementById("manual-word-input"),
          manualMeaningInput: document.getElementById("manual-meaning-input"),
          saveManualWordBtn: document.getElementById("save-manual-word-btn"),
          closeModalBtns: document.querySelectorAll(".close-modal-btn"),
        };

        // --- ë°ì´í„° ì˜ì†ì„± ---
        const saveData = () =>
          localStorage.setItem("wordAppData", JSON.stringify(appState));
        const loadData = () => {
          const data = localStorage.getItem("wordAppData");
          if (data) {
            const parsedData = JSON.parse(data);
            appState = {
              dailyGoal: 30,
              wordsLearnedToday: 0,
              wordbooks: [],
              ...parsedData,
              wordbooks: Array.isArray(parsedData.wordbooks)
                ? parsedData.wordbooks
                : [],
            };
          }
        };

        // --- UI ë Œë”ë§ ---
        const renderGoal = () => {
          DOMElements.goalText.textContent = `${appState.wordsLearnedToday} / ${appState.dailyGoal} ë‹¨ì–´`;
          const progress =
            appState.dailyGoal > 0
              ? (appState.wordsLearnedToday / appState.dailyGoal) * 100
              : 0;
          DOMElements.progressBar.style.width = `${progress}%`;
          DOMElements.dailyGoalInput.value = appState.dailyGoal;
        };
        const renderWordbooks = () => {
          DOMElements.wordbooksList.innerHTML = "";
          if (appState.wordbooks.length === 0) {
            DOMElements.wordbooksList.innerHTML = `<p class="text-gray-500 md:col-span-3 text-center">ë§Œë“¤ì–´ì§„ ë‹¨ì–´ì¥ì´ ì—†ìŠµë‹ˆë‹¤. ìœ„ì—ì„œ ìƒˆ ë‹¨ì–´ì¥ì„ ë§Œë“¤ì–´ë³´ì„¸ìš”!</p>`;
            return;
          }
          appState.wordbooks.forEach((wb) => {
            const card = document.createElement("div");
            const isOdanote = wb.id === "odanote";
            const cardBg = isOdanote ? "bg-red-50" : "bg-white";
            const icon = isOdanote
              ? '<i class="fa-solid fa-book-medical text-red-500 mr-2"></i>'
              : "";

            card.className = `${cardBg} p-6 rounded-xl shadow-md relative`; // relative ì¶”ê°€
            card.innerHTML = `
                    ${
                      !isOdanote
                        ? `<button data-wordbook-id="${wb.id}" class="delete-btn absolute top-4 right-4 text-gray-400 hover:text-red-500 transition"><i class="fa-solid fa-trash-can"></i></button>`
                        : ""
                    }
                    <h3 class="font-bold text-xl mb-2">${icon}${wb.name}</h3>
                    <p class="text-gray-500 mb-4">${wb.words.length} ë‹¨ì–´</p>
                    <div class="flex gap-2 mt-4">
                        <button data-wordbook-id="${
                          wb.id
                        }" class="learn-btn w-full bg-gray-200 text-gray-800 font-bold py-2 rounded-lg hover:bg-gray-300 transition">í•™ìŠµ</button>
                        <button data-wordbook-id="${
                          wb.id
                        }" class="quiz-btn w-full bg-blue-100 text-blue-800 font-bold py-2 rounded-lg hover:bg-blue-200 transition">í€´ì¦ˆ</button>
                    </div>
                `;
            DOMElements.wordbooksList.appendChild(card);
          });
        };
        const renderAll = () => {
          renderGoal();
          renderWordbooks();
        };

        // --- ëª¨ë‹¬ ê´€ë¦¬ ---
        const openModal = (modal) => {
          modal.classList.remove("hidden");
          DOMElements.body.classList.add("modal-open");
        };
        const closeModal = (modal) => {
          if (!modal) return;
          modal.classList.add("hidden");
          const isAnyModalOpen = document.querySelector(
            ".fixed.inset-0:not(.hidden)"
          );
          if (!isAnyModalOpen) DOMElements.body.classList.remove("modal-open");
        };

        // --- ì˜¤ë‹µë…¸íŠ¸ ê¸°ëŠ¥ ---
        const addWordToOdanote = (wordObject) => {
          let odanote = appState.wordbooks.find((wb) => wb.id === "odanote");
          if (!odanote) {
            odanote = {
              id: "odanote",
              name: "ì˜¤ë‹µ ë…¸íŠ¸",
              words: [],
              isOdanote: true,
            };
            appState.wordbooks.push(odanote);
          }
          const isAlreadyIn = odanote.words.some(
            (w) => w.word === wordObject.word
          );
          if (!isAlreadyIn) {
            odanote.words.push(wordObject);
          }
        };

        // --- í•™ìŠµ ê¸°ëŠ¥ ---
        const startLearning = (wordbookId) => {
          const wordbook = appState.wordbooks.find(
            (wb) => wb.id === wordbookId
          );
          if (!wordbook || wordbook.words.length === 0) {
            alert("ë‹¨ì–´ì¥ì— í•™ìŠµí•  ë‹¨ì–´ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ë‹¨ì–´ë¥¼ ì¶”ê°€í•´ì£¼ì„¸ìš”.");
            return;
          }
          learningSession = {
            isActive: true,
            wordbookId,
            words: [...wordbook.words].sort(() => Math.random() - 0.5),
            currentIndex: 0,
          };
          DOMElements.mainView.classList.add("hidden");
          DOMElements.learnView.classList.remove("hidden");
          DOMElements.learnWordbookTitle.textContent = `"${wordbook.name}" í•™ìŠµ ì¤‘`;
          displayCurrentLearnWord();
        };
        const displayCurrentLearnWord = () => {
          if (!learningSession.isActive) return;
          const word = learningSession.words[learningSession.currentIndex];
          DOMElements.learnWordDisplay.textContent = word.word;
          DOMElements.learnMeaningDisplay.textContent = word.meaning;
          DOMElements.learnProgress.textContent = `${
            learningSession.currentIndex + 1
          } / ${learningSession.words.length}`;
        };
        const handleNextLearnCard = () => {
          if (!learningSession.isActive) return;

          if (appState.wordsLearnedToday < appState.dailyGoal) {
            appState.wordsLearnedToday++;
          }
          renderGoal();
          saveData();

          learningSession.currentIndex++;
          if (learningSession.currentIndex >= learningSession.words.length) {
            endLearning();
          } else {
            displayCurrentLearnWord();
          }
        };
        const endLearning = () => {
          if (learningSession.isActive) {
            alert("í•™ìŠµì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!");
            learningSession.isActive = false;
          }
          exitToMain();
        };

        // --- í€´ì¦ˆ ê¸°ëŠ¥ ---
        const startQuiz = (wordbookId) => {
          const wordbook = appState.wordbooks.find(
            (wb) => wb.id === wordbookId
          );
          if (!wordbook || wordbook.words.length === 0) {
            alert("ë‹¨ì–´ì¥ì— í€´ì¦ˆë¥¼ ë³¼ ë‹¨ì–´ê°€ ì—†ìŠµë‹ˆë‹¤.");
            return;
          }
          quizSession = {
            isActive: true,
            wordbookId,
            words: [...wordbook.words].sort(() => Math.random() - 0.5),
            currentIndex: 0,
            score: 0,
            userAnswers: [],
          };
          DOMElements.mainView.classList.add("hidden");
          DOMElements.quizView.classList.remove("hidden");
          DOMElements.quizResultView.classList.add("hidden");
          DOMElements.quizWordbookTitle.textContent = `"${wordbook.name}" í€´ì¦ˆ`;
          displayCurrentQuizQuestion();
        };
        const displayCurrentQuizQuestion = () => {
          const word = quizSession.words[quizSession.currentIndex];
          DOMElements.quizProgress.textContent = `${
            quizSession.currentIndex + 1
          } / ${quizSession.words.length}`;
          DOMElements.quizWord.textContent = word.word;
          DOMElements.quizMeaningInput.value = "";
          DOMElements.quizMeaningInput.focus();
        };
        const submitQuizAnswer = () => {
          if (!quizSession.isActive) return;
          const userAnswer = DOMElements.quizMeaningInput.value.trim();
          const currentWord = quizSession.words[quizSession.currentIndex];

          if (userAnswer === currentWord.meaning) {
            quizSession.score++;
          } else {
            addWordToOdanote(currentWord); // í€´ì¦ˆì—ì„œ í‹€ë¦° ë‹¨ì–´ë§Œ ì˜¤ë‹µë…¸íŠ¸ì— ì¶”ê°€
          }

          quizSession.currentIndex++;
          if (quizSession.currentIndex >= quizSession.words.length) {
            endQuiz();
          } else {
            displayCurrentQuizQuestion();
          }
        };
        const endQuiz = () => {
          quizSession.isActive = false;
          saveData(); // ì˜¤ë‹µë…¸íŠ¸ ë³€ê²½ì‚¬í•­ ì €ì¥

          DOMElements.quizView.classList.add("hidden");
          DOMElements.quizResultView.classList.remove("hidden");

          DOMElements.quizScore.textContent = quizSession.score;
          DOMElements.quizTotal.textContent = quizSession.words.length;

          const percentage =
            (quizSession.score / quizSession.words.length) * 100;
          let feedback = "ì¡°ê¸ˆ ë” ë…¸ë ¥í•´ë´ìš”! ğŸ’ª";
          if (percentage >= 80) feedback = "í›Œë¥­í•´ìš”! ğŸ‰";
          else if (percentage >= 50) feedback = "ì¢‹ì•„ìš”! ì¡°ê¸ˆë§Œ ë”! ğŸ‘";
          DOMElements.quizFeedback.textContent = feedback;
        };

        const exitToMain = () => {
          DOMElements.mainView.classList.remove("hidden");
          DOMElements.learnView.classList.add("hidden");
          DOMElements.quizView.classList.add("hidden");
          DOMElements.quizResultView.classList.add("hidden");
          renderAll();
        };

        // --- ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ì´ˆê¸°í™” ---
        const initEventListeners = () => {
          DOMElements.logo.addEventListener("click", exitToMain);
          DOMElements.editGoalBtn.addEventListener("click", () =>
            openModal(DOMElements.goalModal)
          );
          DOMElements.saveGoalBtn.addEventListener("click", handleSaveGoal);
          DOMElements.createWordbookBtn.addEventListener(
            "click",
            handleCreateWordbook
          );
          DOMElements.addManuallyBtn.addEventListener("click", () =>
            switchModal(DOMElements.addWordModal, DOMElements.manualAddModal)
          );
          DOMElements.addFromPhotoBtn.addEventListener("click", () =>
            switchModal(DOMElements.addWordModal, DOMElements.photoAddModal)
          );
          DOMElements.saveManualWordBtn.addEventListener(
            "click",
            handleSaveManualWord
          );
          DOMElements.savePhotoWordsBtn.addEventListener(
            "click",
            handleSavePhotoWords
          );
          DOMElements.photoUploadArea.addEventListener("click", () =>
            DOMElements.photoUploadInput.click()
          );
          DOMElements.photoUploadInput.addEventListener(
            "change",
            handlePhotoUpload
          );

          DOMElements.wordbooksList.addEventListener("click", (e) => {
            const button = e.target.closest("button");
            if (!button) return;

            const wordbookId =
              button.dataset.wordbookId === "odanote"
                ? "odanote"
                : parseInt(button.dataset.wordbookId, 10);

            if (button.classList.contains("learn-btn"))
              startLearning(wordbookId);
            if (button.classList.contains("quiz-btn")) startQuiz(wordbookId);
            if (button.classList.contains("delete-btn"))
              handleDeleteWordbook(wordbookId); // ì‚­ì œ ë²„íŠ¼ ì´ë²¤íŠ¸ ì¶”ê°€
          });

          DOMElements.learnNextBtn.addEventListener(
            "click",
            handleNextLearnCard
          );
          DOMElements.exitLearnBtn.addEventListener("click", exitToMain);

          DOMElements.nextQuizBtn.addEventListener("click", submitQuizAnswer);
          DOMElements.quizMeaningInput.addEventListener("keydown", (e) => {
            if (e.key === "Enter") submitQuizAnswer();
          });
          DOMElements.exitQuizBtn.addEventListener("click", exitToMain);
          DOMElements.backToMainBtn.addEventListener("click", exitToMain);

          DOMElements.closeModalBtns.forEach((btn) => {
            btn.addEventListener("click", () =>
              closeModal(btn.closest(".fixed"))
            );
          });
        };

        // --- í•¸ë“¤ëŸ¬ í•¨ìˆ˜ë“¤ ---
        const handleDeleteWordbook = (wordbookId) => {
          const wordbookToDelete = appState.wordbooks.find(
            (wb) => wb.id === wordbookId
          );
          if (!wordbookToDelete) return;

          if (
            confirm(
              `'${wordbookToDelete.name}' ë‹¨ì–´ì¥ì„ ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`
            )
          ) {
            appState.wordbooks = appState.wordbooks.filter(
              (wb) => wb.id !== wordbookId
            );
            saveData();
            renderWordbooks();
          }
        };

        const handleSaveGoal = () => {
          const newGoal = parseInt(DOMElements.dailyGoalInput.value, 10);
          if (newGoal > 0) {
            appState.dailyGoal = newGoal;
            saveData();
            renderGoal();
            closeModal(DOMElements.goalModal);
          } else {
            alert("ëª©í‘œëŠ” 1 ì´ìƒì˜ ìˆ«ìë¡œ ì„¤ì •í•´ì£¼ì„¸ìš”.");
          }
        };
        const handleCreateWordbook = () => {
          const name = DOMElements.wordbookNameInput.value.trim();
          if (!name) {
            alert("ë‹¨ì–´ì¥ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            return;
          }
          const newWordbook = { id: Date.now(), name, words: [] };
          appState.wordbooks.push(newWordbook);
          appState.currentWordbookId = newWordbook.id;
          saveData();
          renderWordbooks();
          DOMElements.wordbookNameInput.value = "";
          DOMElements.modalWordbookName.textContent = name;
          openModal(DOMElements.addWordModal);
        };
        const handleSaveManualWord = () => {
          const word = DOMElements.manualWordInput.value.trim();
          const meaning = DOMElements.manualMeaningInput.value.trim();
          if (!word || !meaning) {
            alert("ë‹¨ì–´ì™€ ëœ»ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            return;
          }
          addWordToCurrentBook({ word, meaning });
          DOMElements.manualWordInput.value = "";
          DOMElements.manualMeaningInput.value = "";
          DOMElements.manualWordInput.focus();
          alert(`'${word}' ë‹¨ì–´ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`);
        };
        const handlePhotoUpload = (event) => {
          if (!event.target.files || !event.target.files[0]) return;
          DOMElements.recognizedWordsList.innerHTML = `<p class="text-center text-blue-600">ì´ë¯¸ì§€ ë¶„ì„ ì¤‘... (ë°ëª¨)</p>`;
          setTimeout(() => {
            const demoWords = [
              { word: "Apple", meaning: "ì‚¬ê³¼" },
              { word: "Banana", meaning: "ë°”ë‚˜ë‚˜" },
              { word: "Cherry", meaning: "ì²´ë¦¬" },
            ];
            DOMElements.recognizedWordsList.innerHTML = demoWords
              .map(
                (w) => `
                    <div class="flex items-center gap-2">
                        <input type="checkbox" checked class="h-5 w-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500 photo-word-checkbox">
                        <input type="text" value="${w.word}" class="flex-1 px-2 py-1 border border-gray-300 rounded-md photo-word-input">
                        <input type="text" value="${w.meaning}" class="flex-1 px-2 py-1 border border-gray-300 rounded-md photo-meaning-input">
                    </div>`
              )
              .join("");
          }, 1500);
        };
        const handleSavePhotoWords = () => {
          const wordRows =
            DOMElements.recognizedWordsList.querySelectorAll(".flex");
          let addedCount = 0;
          wordRows.forEach((row) => {
            const checkbox = row.querySelector(".photo-word-checkbox");
            if (checkbox && checkbox.checked) {
              const word = row.querySelector(".photo-word-input").value;
              const meaning = row.querySelector(".photo-meaning-input").value;
              if (word && meaning) {
                addWordToCurrentBook({ word, meaning });
                addedCount++;
              }
            }
          });
          alert(`${addedCount}ê°œì˜ ë‹¨ì–´ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`);
          closeModal(DOMElements.photoAddModal);
        };
        const addWordToCurrentBook = (wordObject) => {
          const currentBook = appState.wordbooks.find(
            (wb) => wb.id === appState.currentWordbookId
          );
          if (currentBook) {
            currentBook.words.push(wordObject);
            saveData();
            renderWordbooks();
          }
        };
        const switchModal = (from, to) => {
          closeModal(from);
          openModal(to);
        };

        // --- ì•± ì´ˆê¸°í™” ---
        const initializeApp = () => {
          loadData();
          renderAll();
          initEventListeners();
        };

        initializeApp();
      });
    </script>
  </body>
</html>
